name: Create Release PR

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: create-release-pr
  cancel-in-progress: false

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure release branch exists and open PR from main
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner
            const repo = context.repo.repo
            const sourceBranch = 'main'
            const releaseBranch = 'release'
            let createdReleaseBranch = false

            try {
              await github.rest.git.getRef({
                owner,
                repo,
                ref: `heads/${releaseBranch}`,
              })
            } catch (error) {
              if (error.status !== 404) {
                throw error
              }

              await github.rest.git.createRef({
                owner,
                repo,
                ref: `refs/heads/${releaseBranch}`,
                sha: context.sha,
              })
              createdReleaseBranch = true
              core.info(`Created '${releaseBranch}' at ${context.sha}`)
            }

            const { data: openPulls } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              base: releaseBranch,
              head: `${owner}:${sourceBranch}`,
              per_page: 1,
            })

            if (openPulls.length > 0) {
              core.info(`Open PR already exists: #${openPulls[0].number}`)
              return
            }

            const { data: comparison } = await github.rest.repos.compareCommits({
              owner,
              repo,
              base: releaseBranch,
              head: sourceBranch,
            })

            if (comparison.status === 'identical') {
              core.info(`No diff between '${sourceBranch}' and '${releaseBranch}'. Skipping PR creation.`)
              return
            }

            const bodyLines = [
              'Automated PR created on push to `main`.',
              '',
              `- Source: \`${sourceBranch}\``,
              `- Target: \`${releaseBranch}\``,
              `- Trigger SHA: \`${context.sha}\``,
            ]

            if (createdReleaseBranch) {
              bodyLines.push(`- Note: \`${releaseBranch}\` branch was created automatically.`)
            }

            const { data: pull } = await github.rest.pulls.create({
              owner,
              repo,
              title: `chore: sync ${sourceBranch} into ${releaseBranch}`,
              head: sourceBranch,
              base: releaseBranch,
              body: bodyLines.join('\n'),
            })

            core.info(`Created PR #${pull.number}: ${pull.html_url}`)
